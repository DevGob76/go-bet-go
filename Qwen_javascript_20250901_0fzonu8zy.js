// --- Objet de traduction ---
const translations = {
    fr: {
        welcome: "Bienvenue sur GO BET GO",
        subtitle: "Prédictions intelligentes et répartition stratégique",
        login: "Accéder à l'application",
        headerSubtitle: "Tableau de bord principal",
        menuPredictions: "Prédictions IA",
        menuDistribution: "Répartition des Mises",
        menuResults: "Résultats & Statistiques",
        menuBalance: "Bilan P&L",
        menuArchives: "Archives",
        titleIa: "Prédictions IA",
        linkChatgpt: "IA ChatGPT",
        linkMistral: "IA Mistral",
        linkClaude: "IA Claude Sonnet 4",
        linkDeepseek: "IA Deepseek",
        linkGemini: "IA Gemini",
        linkCopilot: "IA Copilot",
        titlePerplexity: "Réponse IA Perplexity",
        titleChatgpt: "Réponse IA ChatGPT",
        titleGemini: "Réponse IA Gemini",
        titleCopilot: "Réponse IA Copilot",
        titleSynthesis: "Résultat Synthèse IA",
        btnSynthesize: "Synthétiser les résultats",
        btnArchiveResults: "Archiver résultat prédictions du jour",
        titleArchivedResults: "Résultats Archivés",
        titleDistribution: "Répartition des Mises",
        labelBudget: "Budget",
        labelTauxNet: "Taux Net (%)",
        labelTotalDistribute: "Total à Répartir (€)",
        labelTotalPronostic: "Nombre de Pronostics",
        btnAddBet: "Ajouter un match",
        btnArchiveRepartition: "Archiver Répartition",
        thMatch: "Match",
        thOdd: "Cote",
        thAmount: "Montant (€)",
        thStatus: "Statut",
        titleResults: "Résultats & Statistiques",
        thDate: "Date",
        statsWins: "Victoires :",
        statsLosses: "Défaites :",
        statsVoid: "Nuls :",
        statsTotalProfit: "Profit Total :",
        titleBalance: "Bilan P&L",
        labelInitialCapital: "Capital Initial (€)",
        labelTotalBet: "Total Mises Réparties (€)",
        labelTotalProfit: "Total Profit/Perte (€)",
        labelProfitRate: "Taux de Profit (%)",
        thStartDate: "Date Début",
        thEndDate: "Date Fin",
        thStartBudget: "Budget Début (€)",
        thEndBudget: "Budget Fin (€)",
        thProfit: "Profit (€)",
        thProfitRate: "Taux Profit (%)",
        btnAddRow: "Ajouter une Ligne",
        titleArchives: "Archives Générales",
        btnDeleteArchive: "Supprimer Archives Général",
        titleAdminPanel: "Panel d'Administration",
        btnVerifyAdmin: "Accéder au panel",
        titleUserManagement: "Gestion des utilisateurs",
        btnAddUser: "Ajouter utilisateur",
        btnCloseAdmin: "Fermer"
    },
    en: {
        welcome: "Welcome to GO BET GO",
        subtitle: "Smart Predictions and Strategic Distribution",
        login: "Access the application",
        headerSubtitle: "Main Dashboard",
        menuPredictions: "AI Predictions",
        menuDistribution: "Stake Distribution",
        menuResults: "Results & Statistics",
        menuBalance: "P&L Balance",
        menuArchives: "Archives",
        titleIa: "AI Predictions",
        linkChatgpt: "AI ChatGPT",
        linkMistral: "AI Mistral",
        linkClaude: "AI Claude Sonnet 4",
        linkDeepseek: "AI Deepseek",
        linkGemini: "AI Gemini",
        linkCopilot: "AI Copilot",
        titlePerplexity: "Perplexity AI Response",
        titleChatgpt: "ChatGPT AI Response",
        titleGemini: "Gemini AI Response",
        titleCopilot: "Copilot AI Response",
        titleSynthesis: "AI Synthesis Result",
        btnSynthesize: "Synthesize results",
        btnArchiveResults: "Archive prediction results",
        titleArchivedResults: "Archived Results",
        titleDistribution: "Stake Distribution",
        labelBudget: "Budget",
        labelTauxNet: "Net Rate (%)",
        labelTotalDistribute: "Total to Distribute (€)",
        labelTotalPronostic: "Number of Predictions",
        btnAddBet: "Add a match",
        btnArchiveRepartition: "Archive Distribution",
        thMatch: "Match",
        thOdd: "Odds",
        thAmount: "Amount (€)",
        thStatus: "Status",
        titleResults: "Results & Statistics",
        thDate: "Date",
        statsWins: "Wins:",
        statsLosses: "Losses:",
        statsVoid: "Void:",
        statsTotalProfit: "Total Profit:",
        titleBalance: "P&L Balance",
        labelInitialCapital: "Initial Capital (€)",
        labelTotalBet: "Total Stakes Distributed (€)",
        labelTotalProfit: "Total Profit/Loss (€)",
        labelProfitRate: "Profit Rate (%)",
        thStartDate: "Start Date",
        thEndDate: "End Date",
        thStartBudget: "Start Budget (€)",
        thEndBudget: "End Budget (€)",
        thProfit: "Profit (€)",
        thProfitRate: "Profit Rate (%)",
        btnAddRow: "Add a Row",
        titleArchives: "General Archives",
        btnDeleteArchive: "Delete General Archive",
        titleAdminPanel: "Admin Panel",
        btnVerifyAdmin: "Access panel",
        titleUserManagement: "User Management",
        btnAddUser: "Add user",
        btnCloseAdmin: "Close"
    },
    es: {
        welcome: "Bienvenido a GO BET GO",
        subtitle: "Predicciones inteligentes y distribución estratégica",
        login: "Acceder a la aplicación",
        headerSubtitle: "Panel principal",
        menuPredictions: "Predicciones IA",
        menuDistribution: "Distribución de Apuesta",
        menuResults: "Resultados y Estadísticas",
        menuBalance: "Balance P&L",
        menuArchives: "Archivos",
        titleIa: "Predicciones por IA",
        linkChatgpt: "IA ChatGPT",
        linkMistral: "IA Mistral",
        linkClaude: "IA Claude Sonnet 4",
        linkDeepseek: "IA Deepseek",
        linkGemini: "IA Gemini",
        linkCopilot: "IA Copilot",
        titlePerplexity: "Respuesta IA Perplexity",
        titleChatgpt: "Respuesta IA ChatGPT",
        titleGemini: "Respuesta IA Gemini",
        titleCopilot: "Respuesta IA Copilot",
        titleSynthesis: "Resultado de Síntesis IA",
        btnSynthesize: "Sintetizar resultados",
        btnArchiveResults: "Archivar resultados del día",
        titleArchivedResults: "Resultados Archivados",
        titleDistribution: "Distribución de Apuesta",
        labelBudget: "Presupuesto",
        labelTauxNet: "Tasa Neta (%)",
        labelTotalDistribute: "Total a Distribuir (€)",
        labelTotalPronostic: "Número de Pronósticos",
        btnAddBet: "Agregar un partido",
        btnArchiveRepartition: "Archivar Distribución",
        thMatch: "Partido",
        thOdd: "Cuota",
        thAmount: "Monto (€)",
        thStatus: "Estado",
        titleResults: "Resultados y Estadísticas",
        thDate: "Fecha",
        statsWins: "Victorias:",
        statsLosses: "Derrotas:",
        statsVoid: "Anulados:",
        statsTotalProfit: "Ganancia Total:",
        titleBalance: "Balance P&L",
        labelInitialCapital: "Capital Inicial (€)",
        labelTotalBet: "Total de Apuestas Repartidas (€)",
        labelTotalProfit: "Total Ganancia/Pérdida (€)",
        labelProfitRate: "Tasa de Ganancia (%)",
        thStartDate: "Fecha de Inicio",
        thEndDate: "Fecha de Fin",
        thStartBudget: "Presupuesto Inicial (€)",
        thEndBudget: "Presupuesto Final (€)",
        thProfit: "Ganancia (€)",
        thProfitRate: "Tasa de Ganancia (%)",
        btnAddRow: "Agregar una Fila",
        titleArchives: "Archivos Generales",
        btnDeleteArchive: "Eliminar Archivo General",
        titleAdminPanel: "Panel de Administración",
        btnVerifyAdmin: "Acceder al panel",
        titleUserManagement: "Gestión de Usuarios",
        btnAddUser: "Agregar usuario",
        btnCloseAdmin: "Cerrar"
    },
    de: {
        welcome: "Willkommen bei GO BET GO",
        subtitle: "Intelligente Vorhersagen und strategische Verteilung",
        login: "Zugriff auf die Anwendung",
        headerSubtitle: "Hauptdashboard",
        menuPredictions: "KI-Vorhersagen",
        menuDistribution: "Einsatzverteilung",
        menuResults: "Ergebnisse & Statistiken",
        menuBalance: "Gewinn-Verlust-Bilanz",
        menuArchives: "Archive",
        titleIa: "KI-Vorhersagen",
        linkChatgpt: "KI ChatGPT",
        linkMistral: "KI Mistral",
        linkClaude: "KI Claude Sonnet 4",
        linkDeepseek: "KI Deepseek",
        linkGemini: "KI Gemini",
        linkCopilot: "KI Copilot",
        titlePerplexity: "Perplexity KI-Antwort",
        titleChatgpt: "ChatGPT KI-Antwort",
        titleGemini: "Gemini KI-Antwort",
        titleCopilot: "Copilot KI-Antwort",
        titleSynthesis: "KI-Synthese Ergebnis",
        btnSynthesize: "Ergebnisse synthetisieren",
        btnArchiveResults: "Tagesvorhersagen archivieren",
        titleArchivedResults: "Archivierte Ergebnisse",
        titleDistribution: "Einsatzverteilung",
        labelBudget: "Budget",
        labelTauxNet: "Nettoquote (%)",
        labelTotalDistribute: "Gesamt zu verteilen (€)",
        labelTotalPronostic: "Anzahl der Prognosen",
        btnAddBet: "Spiel hinzufügen",
        btnArchiveRepartition: "Verteilung archivieren",
        thMatch: "Spiel",
        thOdd: "Quote",
        thAmount: "Betrag (€)",
        thStatus: "Status",
        titleResults: "Ergebnisse & Statistiken",
        thDate: "Datum",
        statsWins: "Siege:",
        statsLosses: "Niederlagen:",
        statsVoid: "Ungültig:",
        statsTotalProfit: "Gesamtgewinn:",
        titleBalance: "Gewinn-Verlust-Bilanz",
        labelInitialCapital: "Anfangskapital (€)",
        labelTotalBet: "Gesamt Einsatz (€)",
        labelTotalProfit: "Gesamt Gewinn/Verlust (€)",
        labelProfitRate: "Gewinnrate (%)",
        thStartDate: "Anfangsdatum",
        thEndDate: "Enddatum",
        thStartBudget: "Anfangsbudget (€)",
        thEndBudget: "Endbudget (€)",
        thProfit: "Gewinn (€)",
        thProfitRate: "Gewinnrate (%)",
        btnAddRow: "Zeile hinzufügen",
        titleArchives: "Allgemeine Archive",
        btnDeleteArchive: "Allgemeines Archiv löschen",
        titleAdminPanel: "Admin-Panel",
        btnVerifyAdmin: "Zugriff auf Panel",
        titleUserManagement: "Benutzerverwaltung",
        btnAddUser: "Benutzer hinzufügen",
        btnCloseAdmin: "Schließen"
    }
};

// --- Variables globales ---
const ADMIN_CODE = "Gob19*20";
const ADMIN_USER = { name: "john gobolo", phone: "2250586214172" };
let authorizedUsers = [];
let currentUser = null;
let archivedResults = [];
let archivedRepartitions = [];
let resultsArchives = [];
let generalArchives = [];
let profitLossData = [];

// --- Fonction de traduction ---
function changeLanguage() {
    const lang = document.getElementById('language-select').value;
    const t = translations[lang];

    // Sauvegarder la langue
    localStorage.setItem('appLanguage', lang);

    // Mettre à jour tous les éléments
    document.getElementById('subtitle').textContent = t.subtitle;
    document.getElementById('btn-login').textContent = t.login;
    document.getElementById('header-subtitle').textContent = t.headerSubtitle;
    document.getElementById('menu-predictions').textContent = t.menuPredictions;
    document.getElementById('menu-distribution').textContent = t.menuDistribution;
    document.getElementById('menu-results').textContent = t.menuResults;
    document.getElementById('menu-balance').textContent = t.menuBalance;
    document.getElementById('menu-archives').textContent = t.menuArchives;
    document.getElementById('title-ia').textContent = t.titleIa;
    document.getElementById('link-chatgpt').textContent = t.linkChatgpt;
    document.getElementById('link-mistral').textContent = t.linkMistral;
    document.getElementById('link-claude').textContent = t.linkClaude;
    document.getElementById('link-deepseek').textContent = t.linkDeepseek;
    document.getElementById('link-gemini').textContent = t.linkGemini;
    document.getElementById('link-copilot').textContent = t.linkCopilot;
    document.getElementById('title-perplexity').textContent = t.titlePerplexity;
    document.getElementById('title-chatgpt').textContent = t.titleChatgpt;
    document.getElementById('title-gemini').textContent = t.titleGemini;
    document.getElementById('title-copilot').textContent = t.titleCopilot;
    document.getElementById('title-synthesis').textContent = t.titleSynthesis;
    document.getElementById('btn-synthesize').textContent = t.btnSynthesize;
    document.getElementById('btn-archive-results').textContent = t.btnArchiveResults;
    document.getElementById('title-archived-results').textContent = t.titleArchivedResults;
    document.getElementById('title-distribution').textContent = t.titleDistribution;
    document.getElementById('label-budget').textContent = t.labelBudget;
    document.getElementById('label-taux-net').textContent = t.labelTauxNet;
    document.getElementById('label-total-distribute').textContent = t.labelTotalDistribute;
    document.getElementById('label-total-pronostic').textContent = t.labelTotalPronostic;
    document.getElementById('btn-add-bet').textContent = t.btnAddBet;
    document.getElementById('btn-archive-repartition').textContent = t.btnArchiveRepartition;
    document.getElementById('th-match').textContent = t.thMatch;
    document.getElementById('th-odd').textContent = t.thOdd;
    document.getElementById('th-amount').textContent = t.thAmount;
    document.getElementById('th-status').textContent = t.thStatus;
    document.getElementById('title-results').textContent = t.titleResults;
    document.getElementById('th-date').textContent = t.thDate;
    document.getElementById('stats-wins').textContent = t.statsWins;
    document.getElementById('stats-losses').textContent = t.statsLosses;
    document.getElementById('stats-void').textContent = t.statsVoid;
    document.getElementById('stats-total-profit').textContent = t.statsTotalProfit;
    document.getElementById('title-balance').textContent = t.titleBalance;
    document.getElementById('label-initial-capital').textContent = t.labelInitialCapital;
    document.getElementById('label-total-bet').textContent = t.labelTotalBet;
    document.getElementById('label-total-profit').textContent = t.labelTotalProfit;
    document.getElementById('label-profit-rate').textContent = t.labelProfitRate;
    document.getElementById('th-start-date').textContent = t.thStartDate;
    document.getElementById('th-end-date').textContent = t.thEndDate;
    document.getElementById('th-start-budget').textContent = t.thStartBudget;
    document.getElementById('th-end-budget').textContent = t.thEndBudget;
    document.getElementById('th-profit').textContent = t.thProfit;
    document.getElementById('th-profit-rate').textContent = t.thProfitRate;
    document.getElementById('btn-add-row').textContent = t.btnAddRow;
    document.getElementById('title-archives').textContent = t.titleArchives;
    document.getElementById('btn-delete-archive').textContent = t.btnDeleteArchive;
    document.getElementById('title-admin-panel').textContent = t.titleAdminPanel;
    document.getElementById('btn-verify-admin').textContent = t.btnVerifyAdmin;
    document.getElementById('title-user-management').textContent = t.titleUserManagement;
    document.getElementById('btn-add-user').textContent = t.btnAddUser;
    document.getElementById('btn-close-admin').textContent = t.btnCloseAdmin;
}

// --- Gestion des utilisateurs ---
function loadUsersFromLocalStorage() {
    const saved = localStorage.getItem('authorizedUsers');
    authorizedUsers = saved ? JSON.parse(saved) : [];
}

function saveUsersToLocalStorage() {
    localStorage.setItem('authorizedUsers', JSON.stringify(authorizedUsers));
}

function renderUsersList() {
    const container = document.getElementById('usersList');
    container.innerHTML = '';
    authorizedUsers.forEach((user, index) => {
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
            <span>${user.name} (${user.phone})</span>
            <button onclick="deleteUser(${index})">Supprimer</button>
        `;
        container.appendChild(div);
    });
}

function deleteUser(index) {
    authorizedUsers.splice(index, 1);
    saveUsersToLocalStorage();
    renderUsersList();
    showPopup('Succès', 'Utilisateur supprimé avec succès');
}

function addUser() {
    const name = document.getElementById('newUserName').value.trim();
    const phone = document.getElementById('newUserPhone').value.trim().replace(/\s/g, '');
    if (!name || !phone) return showPopup('Erreur', 'Veuillez remplir tous les champs');
    if (authorizedUsers.some(u => u.phone === phone)) return showPopup('Erreur', 'Ce numéro existe déjà');
    authorizedUsers.push({ name, phone });
    saveUsersToLocalStorage();
    renderUsersList();
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserPhone').value = '';
    showPopup('Succès', 'Utilisateur ajouté');
}

// --- Fonctions existantes (inchangées) ---
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    if (pageId === 'resultsPage') updateResultsStats();
    if (pageId === 'balancePage') updateProfitCalculations();
    if (pageId === 'archivesPage') {
        updateGeneralArchivesDropdown();
        updateDeleteButtonState();
    }
}

function showPopup(title, message) {
    document.getElementById('popupTitle').textContent = title;
    document.getElementById('popupMessage').textContent = message;
    document.getElementById('popup').style.display = 'flex';
}

function closePopup() {
    document.getElementById('popup').style.display = 'none';
}

function openAdminPanel() {
    document.getElementById('adminPanel').style.display = 'flex';
}

function closeAdminPanel() {
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('adminCodeInput').value = '';
    document.getElementById('adminContent').style.display = 'none';
}

function verifyAdminCode() {
    const code = document.getElementById('adminCodeInput').value;
    if (code === ADMIN_CODE) {
        document.getElementById('adminContent').style.display = 'block';
        renderUsersList();
    } else {
        showPopup('Erreur', 'Code incorrect');
    }
}

function login() {
    const nameInput = document.getElementById('nameInput').value.trim();
    const phoneInput = document.getElementById('phoneInput').value.trim().replace(/\s/g, '');
    if (!nameInput || !phoneInput) {
        return showPopup('Erreur', 'Veuillez entrer votre nom et votre numéro de téléphone');
    }
    const user = authorizedUsers.find(u => u.phone === phoneInput && u.name.toLowerCase() === nameInput.toLowerCase());
    if (user) {
        currentUser = user;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainPage').classList.add('active');
        showPopup('Bienvenue', `Accès autorisé à Go Bet Go, ${user.name} !`);
        loadFromLocalStorage();
    } else {
        showPopup('Accès Refusé', 'Nom ou numéro incorrect');
    }
}

function saveToLocalStorage() {
    if (!currentUser) return;
    const userData = {
        archivedResults,
        archivedRepartitions,
        resultsArchives,
        generalArchives,
        profitLossData,
        initialCapital: document.getElementById('initialCapital').value
    };
    localStorage.setItem(`user_${currentUser.phone}`, JSON.stringify(userData));
}

function loadFromLocalStorage() {
    if (!currentUser) return;
    const saved = localStorage.getItem(`user_${currentUser.phone}`);
    if (saved) {
        const data = JSON.parse(saved);
        Object.assign(window, data);
        if (profitLossData.length === 0) addProfitLossRow();
        updateResultsArchiveDropdown();
        updateGeneralArchivesDropdown();
        updateProfitCalculations();
    } else {
        addProfitLossRow();
    }
}

// --- Fonctions de répartition ---
function calculateBets() {
    const budget = parseFloat(document.getElementById('budgetInput').value) || 0;
    const tauxNet = parseFloat(document.getElementById('tauxNetInput').value) || 0;
    const totalToDistribute = budget * (tauxNet / 100);
    document.getElementById('totalToDistribute').value = totalToDistribute.toFixed(2);
    updateTotalPronostic();
}

function addBetRow() {
    const tbody = document.getElementById('betsTableBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" class="match-input" placeholder="Ex: PSG - OM"></td>
        <td><input type="number" step="0.01" class="odd-input" placeholder="2.50" onchange="updateBetAmount(this)"></td>
        <td><input type="number" class="amount-input" readonly></td>
        <td>
            <div class="bet-status-btn-container">
                <button class="win" onclick="setBetStatus(this, 'win')">Win</button>
                <button class="lose" onclick="setBetStatus(this, 'lose')">Lose</button>
                <button class="void" onclick="setBetStatus(this, 'void')">Void</button>
            </div>
        </td>
    `;
    tbody.appendChild(tr);
    updateTotalPronostic();
}

function updateBetAmount(oddInput) {
    const row = oddInput.closest('tr');
    const odd = parseFloat(oddInput.value) || 1;
    const totalToDistribute = parseFloat(document.getElementById('totalToDistribute').value) || 0;
    const totalRows = document.querySelectorAll('#betsTableBody tr').length;
    const amount = (totalToDistribute / totalRows) / (odd - 1);
    row.querySelector('.amount-input').value = amount.toFixed(2);
}

function updateTotalPronostic() {
    const total = document.querySelectorAll('#betsTableBody tr').length;
    document.getElementById('totalPronostic').value = total;
    document.querySelectorAll('#betsTableBody .odd-input').forEach(input => updateBetAmount(input));
}

function setBetStatus(button, status) {
    const row = button.closest('tr');
    row.querySelectorAll('.bet-status-btn-container button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    const match = row.querySelector('.match-input').value;
    const odd = parseFloat(row.querySelector('.odd-input').value) || 1;
    const amount = parseFloat(row.querySelector('.amount-input').value) || 0;
    let profit = 0;
    if (status === 'win') profit = (odd - 1) * amount;
    else if (status === 'lose') profit = -amount;
    // Mettre à jour le tableau des résultats
    const resultsBody = document.getElementById('resultsTableBody');
    let resultRow = Array.from(resultsBody.querySelectorAll('tr')).find(r => r.dataset.match === match);
    if (!resultRow) {
        resultRow = document.createElement('tr');
        resultRow.dataset.match = match;
        resultRow.innerHTML = `
            <td>${new Date().toISOString().split('T')[0]}</td>
            <td>${match}</td>
            <td>${odd}</td>
            <td>${amount.toFixed(2)}</td>
            <td>-</td>
            <td>-</td>
        `;
        resultsBody.appendChild(resultRow);
    }
    resultRow.cells[4].textContent = status.charAt(0).toUpperCase() + status.slice(1);
    resultRow.cells[5].textContent = profit.toFixed(2);
    updateResultsStats();
}

function archiveRepartition() {
    const date = new Date().toISOString().split('T')[0];
    const repartition = {
        date,
        budget: document.getElementById('budgetInput').value,
        tauxNet: document.getElementById('tauxNetInput').value,
        totalToDistribute: document.getElementById('totalToDistribute').value,
        bets: []
    };
    document.querySelectorAll('#betsTableBody tr').forEach(row => {
        repartition.bets.push({
            match: row.querySelector('.match-input').value,
            odd: row.querySelector('.odd-input').value,
            amount: row.querySelector('.amount-input').value
        });
    });
    archivedRepartitions.push(repartition);
    saveToLocalStorage();
    updateResultsArchiveDropdown();
    showPopup('Succès', 'Répartition archivée');
}

// --- Fonctions de résultats ---
function updateResultsStats() {
    let wins = 0, losses = 0, voids = 0, totalProfit = 0;
    document.querySelectorAll('#resultsTableBody tr').forEach(row => {
        const status = row.cells[4].textContent.toLowerCase();
        const profit = parseFloat(row.cells[5].textContent) || 0;
        if (status === 'win') wins++;
        else if (status === 'lose') losses++;
        else if (status === 'void') voids++;
        totalProfit += profit;
    });
    document.getElementById('winCount').textContent = wins;
    document.getElementById('lossCount').textContent = losses;
    document.getElementById('voidCount').textContent = voids;
    document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
}

function updateResultsArchiveDropdown() {
    const select = document.getElementById('archiveDropdown');
    select.innerHTML = '<option value="">Sélectionnez un résultat archivé</option>';
    archivedRepartitions.forEach((archive, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `Répartition du ${archive.date}`;
        select.appendChild(option);
    });
}

function displayArchivedResults() {
    const select = document.getElementById('archiveDropdown');
    const index = select.value;
    const container = document.getElementById('archivedResults');
    if (index === '') {
        container.innerHTML = '';
        return;
    }
    const archive = archivedRepartitions[index];
    container.innerHTML = `
        <h4>Répartition du ${archive.date}</h4>
        <p>Budget: ${archive.budget} €</p>
        <p>Taux Net: ${archive.tauxNet}%</p>
        <p>Total à Répartir: ${archive.totalToDistribute} €</p>
        <table style="width:100%; margin-top:10px; border-collapse: collapse; color: white;">
            <tr style="background:rgba(255,255,255,0.1);"><th>Match</th><th>Cote</th><th>Montant (€)</th></tr>
            ${archive.bets.map(bet => `<tr><td>${bet.match}</td><td>${bet.odd}</td><td>${bet.amount}</td></tr>`).join('')}
        </table>
    `;
}

// --- Synthèse IA ---
function synthesizeResults() {
    const perplexity = document.getElementById('perplexityResponse').innerText;
    const chatgpt = document.getElementById('chatgptResponse').innerText;
    const gemini = document.getElementById('geminiResponse').innerText;
    const copilot = document.getElementById('copilotResponse').innerText;
    const synthesisContainer = document.getElementById('synthesisResults');
    synthesisContainer.innerHTML = `
        <h4>Synthèse des prédictions IA :</h4>
        <p><strong>Perplexity:</strong> ${perplexity.substring(0, 200)}...</p>
        <p><strong>ChatGPT:</strong> ${chatgpt.substring(0, 200)}...</p>
        <p><strong>Gemini:</strong> ${gemini.substring(0, 200)}...</p>
        <p><strong>Copilot:</strong> ${copilot.substring(0, 200)}...</p>
    `;
}

function archiveResults() {
    const date = new Date().toISOString().split('T')[0];
    const results = document.getElementById('synthesisResults').innerHTML;
    archivedResults.push({ date, results });
    saveToLocalStorage();
    updateGeneralArchivesDropdown();
    showPopup('Succès', 'Prédictions archivées');
}

// --- Bilan P&L ---
function updateProfitCalculations() {
    let totalBet = 0;
    document.querySelectorAll('#betsTableBody .amount-input').forEach(input => {
        totalBet += parseFloat(input.value) || 0;
    });
    document.getElementById('totalMisesReparties').value = totalBet.toFixed(2);
    const totalProfit = parseFloat(document.getElementById('totalProfit').textContent) || 0;
    document.getElementById('totalProfitLoss').value = totalProfit.toFixed(2);
    const initialCapital = parseFloat(document.getElementById('initialCapital').value) || 1;
    const profitRate = (totalProfit / initialCapital) * 100;
    document.getElementById('profitRate').value = profitRate.toFixed(2);
}

function addProfitLossRow() {
    const tableBody = document.getElementById('profitLossTableBody');
    const rowCount = tableBody.rows.length + 1;
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${rowCount}</td>
        <td><input type="date"></td>
        <td><input type="date"></td>
        <td><input type="number" value="300" onchange="updateProfitCalculations()"></td>
        <td><input type="number" value="350" onchange="updateProfitCalculations()"></td>
        <td><input type="number" readonly></td>
        <td><input type="number" readonly></td>
    `;
    tableBody.appendChild(row);
}

// --- Archives générales ---
function updateGeneralArchivesDropdown() {
    const select = document.getElementById('generalArchivesDropdown');
    select.innerHTML = '<option value="">Sélectionnez une fiche de synthèse</option>';
    archivedResults.forEach((item, index) => {
        const option = document.createElement('option');
        option.value = `prediction-${index}`;
        option.textContent = `Synthèse IA - ${item.date}`;
        select.appendChild(option);
    });
    archivedRepartitions.forEach((item, index) => {
        const option = document.createElement('option');
        option.value = `repartition-${index}`;
        option.textContent = `Répartition - ${item.date}`;
        select.appendChild(option);
    });
}

function displayGeneralArchivedResults() {
    const value = document.getElementById('generalArchivesDropdown').value;
    const container = document.getElementById('generalArchivedResults');
    container.innerHTML = '';
    if (value === '') return;
    const [type, index] = value.split('-');
    if (type === 'prediction') {
        const item = archivedResults[index];
        const div = document.createElement('div');
        div.className = 'general-archive-item';
        div.innerHTML = `
            <div class="general-archive-header">
                <span class="general-archive-title">Synthèse IA</span>
                <span class="general-archive-date">${item.date}</span>
            </div>
            <div class="general-archive-content">${item.results}</div>
        `;
        container.appendChild(div);
    } else if (type === 'repartition') {
        const item = archivedRepartitions[index];
        const div = document.createElement('div');
        div.className = 'general-archive-item';
        div.innerHTML = `
            <div class="general-archive-header">
                <span class="general-archive-title">Répartition de Mise</span>
                <span class="general-archive-date">${item.date}</span>
            </div>
            <div class="general-archive-content">
                <p><strong>Budget:</strong> ${item.budget} €</p>
                <p><strong>Taux Net:</strong> ${item.tauxNet}%</p>
                <p><strong>Total à Répartir:</strong> ${item.totalToDistribute} €</p>
                <table style="width:100%; margin-top:10px; border-collapse: collapse; color: white;">
                    <tr style="background:rgba(255,255,255,0.1);"><th>Match</th><th>Cote</th><th>Montant (€)</th></tr>
                    ${item.bets.map(bet => `<tr><td>${bet.match}</td><td>${bet.odd}</td><td>${bet.amount}</td></tr>`).join('')}
                </table>
            </div>
        `;
        container.appendChild(div);
    }
    updateDeleteButtonState();
}

function updateDeleteButtonState() {
    const select = document.getElementById('generalArchivesDropdown');
    document.getElementById('deleteGeneralArchiveBtn').disabled = select.value === '';
}

function deleteGeneralArchive() {
    const value = document.getElementById('generalArchivesDropdown').value;
    if (value === '') {
        return showPopup('Erreur', 'Veuillez sélectionner une archive à supprimer');
    }
    const [type, index] = value.split('-');
    if (type === 'prediction') {
        archivedResults.splice(index, 1);
    } else if (type === 'repartition') {
        archivedRepartitions.splice(index, 1);
    }
    saveToLocalStorage();
    document.getElementById('generalArchivesDropdown').value = '';
    document.getElementById('generalArchivedResults').innerHTML = '';
    updateGeneralArchivesDropdown();
    updateDeleteButtonState();
    showPopup('Succès', 'Archive supprimée');
}

// --- Initialisation ---
document.addEventListener('DOMContentLoaded', () => {
    loadUsersFromLocalStorage();
    if (!authorizedUsers.some(u => u.phone === ADMIN_USER.phone)) {
        authorizedUsers.push(ADMIN_USER);
        saveUsersToLocalStorage();
    }

    // Charger la langue sauvegardée
    const savedLang = localStorage.getItem('appLanguage') || 'fr';
    document.getElementById('language-select').value = savedLang;
    changeLanguage();

    // Écouter les changements de langue
    document.getElementById('language-select').addEventListener('change', changeLanguage);
});